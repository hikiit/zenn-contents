---
title: "Flutter + Firebaseã§iOSã¨Androidã®å®šæœŸè³¼å…¥(ã‚µãƒ–ã‚¹ã‚¯)ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸª™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["flutter", "firebase", "cloudfunctions"]
published: true
---

**2021.08.12 ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œã‚Šç›´ã—ã«ã‚ˆã‚‹å†æŠ•ç¨¿**
**2021.09.12 ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé–¢ä¿‚ã®æƒ…å ±ã‚’æ›´æ–°**

## ã¯ã˜ã‚ã«

å…ˆæ—¥å…¬é–‹ã—ãŸã‚¢ãƒ—ãƒªã§ã¯å®šæœŸè³¼å…¥ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã„ã‚ã‚†ã‚‹ã‚µãƒ–ã‚¹ã‚¯ã§ã™ã€‚

Flutter(iOS/Android)ã§ã‚µãƒ–ã‚¹ã‚¯ã®å®Ÿè£…ä¾‹ã¯å°‘ãªãã€è‹¦åŠ´ã—ãŸç‚¹ã‚‚ã‚ã‚‹ã®ã§çŸ¥è¦‹ã‚’å…¬é–‹ã—ã¾ã™ã€‚å®šæœŸè³¼å…¥ã®ä»•æ§˜ã«ã¤ã„ã¦ä¸å¯§ã«è§£èª¬ã™ã‚‹ã¨ã„ã†ã‚ˆã‚Šã¯ã€å®Ÿéš›ã«ç§ãŒã©ã®ã‚ˆã†ãªå®Ÿè£…ã‚’ã—ã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚

### æ³¨æ„äº‹é …

- æœ¬è¨˜äº‹ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€æŠ€è¡“è¨˜äº‹æŠ•ç¨¿ã‚µã‚¤ãƒˆã€å€‹äººãƒ–ãƒ­ã‚°ãªã©ã®æƒ…å ±ã‚’è‡ªåˆ†ãªã‚Šã«è§£é‡ˆã—ã¦å®Ÿè£…ã—ãŸå†…å®¹ã§ã™ã€‚
- èª²é‡‘å‘¨ã‚Šã¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒå¤šã„ãŸã‚ã€å¸¸ã«æœ€æ–°æƒ…å ±ã®ç¢ºèªã‚’æ¨å¥¨ã—ã¾ã™ã€‚ç‰¹ã«è‹±èªç‰ˆå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯æœ€ã‚‚ä¿¡é ¼ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚
- æœ¬ç•ªç’°å¢ƒã§å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿ã§ã™ãŒã€ã‚µãƒ–ã‚¹ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç¾çŠ¶æ•°åã§ã™ã€‚ã‚µãƒ–ã‚¹ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤šæ•°ã®å ´åˆã«ã‚ˆã‚‹å½±éŸ¿ã¯æœªæ¤œè¨¼ã§ã™ã€‚
- ãã®ä»–ã€ååˆ†ã«æ¤œè¨¼ã§ãã¦ã„ãªã„å†…å®¹ãŒã‚ã‚Šã¾ã™ã€‚ä½•ã‹ãŠæ°—ã¥ãã®ç‚¹ãŒã‚ã‚Œã°ã”æŒ‡æ‘˜ã„ãŸã ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ã€‚

### ç’°å¢ƒ

æœ¬è¨˜äº‹åŸ·ç­†æ™‚ã®ç’°å¢ƒã§ã™ã€‚

Flutter ç’°å¢ƒã¯ä¸‹è¨˜ã§ã™ã€‚

```sh
[âœ“] Flutter (Channel stable, 2.2.3, on macOS 11.4 20F71 darwin-x64, locale en-JP)
[âœ“] Android toolchain - develop for Android devices (Android SDK version 29.0.3)
[âœ“] Xcode - develop for iOS and macOS
[âœ“] Chrome - develop for the web
[âœ“] Android Studio (version 4.0)
[âœ“] VS Code (version 1.59.1)
[âœ“] Connected device (1 available)

â€¢ No issues found!
```

åˆ©ç”¨ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸€è¦§ (é–¢ä¿‚ã®ã‚ã‚‹ã‚‚ã®ã ã‘æŠœç²‹)

```yaml
dependencies:
  flutter:
    sdk: flutter

  # firebase
  firebase_core: ^1.5.0
  cloud_firestore: ^2.5.0
  cloud_functions: ^3.0.1
  firebase_auth: ^3.0.2
  firebase_remote_config: ^0.10.0+4
  firebase_analytics: ^8.3.0

  # billing
  # (æ³¨æ„ Androidã«ã¤ã„ã¦) ä»Šå¾Œ Billing Library ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 3ä»¥é™ãŒå¿…é ˆã«ãªã‚Šã¾ã™ã€‚
  # in_app_purchaseã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³0.5.0ã‹ã‚‰Billing Library ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 3ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
  in_app_purchase: ^1.0.8
```

## å®Ÿè£…ã—ãªã‘ã‚Œã°ã„ã‘ãªã„ã“ã¨

ã‚µãƒ–ã‚¹ã‚¯æ©Ÿèƒ½ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ(Flutter ã‚¢ãƒ—ãƒª) / ã‚µãƒ¼ãƒãƒ¼ä¸¡æ–¹ã®å®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚

ãã‚Œãã‚Œã–ã£ãã‚Šã¨ã—ãŸå½¹å‰²ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®å®Ÿè£…

- ã‚¹ãƒˆã‚¢æƒ…å ±ã®å–å¾—  
  GooglePlayStore / AppStore ã‹ã‚‰ã‚¹ãƒˆã‚¢æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚  
  ä¸»ã«ã‚µãƒ–ã‚¹ã‚¯ã®æƒ…å ±å–å¾—(é‡‘é¡ãªã©)ã‚’è¡Œã„ã¾ã™ã€‚

- ã‚µãƒ–ã‚¹ã‚¯ã®è³¼å…¥  
  ã‚¢ãƒ—ãƒªå†…ã§ã‚µãƒ–ã‚¹ã‚¯ã®è³¼å…¥ã‚’æ¤œçŸ¥ã—ã¾ã™ã€‚  
  æ¤œçŸ¥ã—ãŸè³¼å…¥æƒ…å ±ã¯ã‚µãƒ¼ãƒãƒ¼ã«æ¸¡ã—ã€æ­£è¦ã®ã‚‚ã®ã§ã‚ã‚‹ã‹æ¤œè¨¼ã—ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚

- ã‚µãƒ–ã‚¹ã‚¯çŠ¶æ³ã®ãƒã‚§ãƒƒã‚¯  
  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ–ã‚¹ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚‹ã‹å¦ã‹ã§ã‚¢ãƒ—ãƒªå†…ã§å‡¦ç†ã‚’åˆ†ã‘ã¾ã™ã€‚ã‚µãƒ–ã‚¹ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚‹ã‹å¦ã‹ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§åˆ¤æ–­ã—ã¾ã™ã€‚

- è³¼å…¥æƒ…å ±ã®ãƒªã‚¹ãƒˆã‚¢  
  ã‚¢ãƒ—ãƒªã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã©ã«ã‚ˆã‚Šãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆãŸçŠ¶æ…‹ã‹ã‚‰ã§ã‚‚å¾©å¸°å¯èƒ½ã«ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’ç”¨æ„ã—ã¾ã™ã€‚  
  iOS ã§ã¯å¿…é ˆã¨ã•ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

### ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å®Ÿè£…

- è³¼å…¥æƒ…å ±ã®æ¤œè¨¼  
  ã‚¢ãƒ—ãƒªã‹ã‚‰æ¸¡ã•ã‚ŒãŸè³¼å…¥æƒ…å ±ãŒæ­£è¦ã®ã‚‚ã®ã‹ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

- è³¼å…¥æƒ…å ±ã®ä¿å­˜  
  æ¤œè¨¼æ¸ˆã¿ã®è³¼å…¥æƒ…å ±ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¾ã™ã€‚

- è³¼å…¥æƒ…å ±ã®æ›´æ–°  
  ã‚µãƒ–ã‚¹ã‚¯ã®æ›´æ–°ç¢ºèªã‚’è¡Œã„ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°ã—ã¾ã™ã€‚

## äº‹å‰æº–å‚™

è©³ç´°ã¯å‰²æ„›ã—ã¾ã™ãŒã€äºˆã‚å„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ãƒˆã‚¢ã‹ã‚‰ã‚µãƒ–ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

ã‚µãƒ–ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ ä½œæˆæ™‚ã«è»½ããƒãƒã£ãŸã¨ã“ã‚ã ã‘è¨˜è¼‰ã—ã¦ãŠãã¾ã™ã€‚

### ã‚¢ãƒ—ãƒªå†…ã‚¢ã‚¤ãƒ†ãƒ (èª²é‡‘ã‚¢ã‚¤ãƒ†ãƒ )ã¯å‰Šé™¤ã§ããªã„

#### Android

åŸºæœ¬çš„ã«ä¸€åº¦ã‚¢ãƒ—ãƒªå†…ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã—ãŸã‚‰å‰Šé™¤ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã¾ãŸã€ä¸€åº¦ã‚¢ãƒ—ãƒªå†…ã‚¢ã‚¤ãƒ†ãƒ ã‚’æœ‰åŠ¹åŒ–ã—ãŸã‚‰ç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

ç§ã®çŸ¥ã‚‹å”¯ä¸€ã®æ–¹æ³•ã¨ã—ã¦ã€Œã‚¢ãƒ—ãƒªã‚’å‰Šé™¤ã™ã‚‹ã€ã¨èª²é‡‘ã‚¢ã‚¤ãƒ†ãƒ ã‚‚ã‚ã¨ã‚‚å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ä¸€åº¦ã§ã‚‚ã€ŒPlay Store ã‚’åˆ©ç”¨ã™ã‚‹é…ä¿¡ã€ã‚’è¡Œã£ãŸå ´åˆã¯ã‚¢ãƒ—ãƒªã‚’å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚  
ãªãŠã€ŒPlay Store ã‚’åˆ©ç”¨ã™ã‚‹é…ä¿¡ã€ã«ã¯ã€ **å†…éƒ¨ãƒ†ã‚¹ãƒˆã‚„ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ãƒ†ã‚¹ãƒˆãŒå«ã¾ã‚Œã¾ã™ã€‚**

ç§ã¯ã“ã‚Œã‚’çŸ¥ã‚‰ãšã€Œå¾Œã§ä¸€æ—¦ã‚¢ãƒ—ãƒªã‚’å‰Šé™¤ã™ã‚Œã°ã„ã„ã‚„ã€ã¨è€ƒãˆã¦ã„ãŸã®ã§ã€çµæœçš„ã«ç¾åœ¨ã¯ä½¿ã£ã¦ã„ãªã„èª²é‡‘ã‚¢ã‚¤ãƒ†ãƒ ãŒ 2 ã¤ã»ã©å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚

#### iOS

å‰Šé™¤ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€åŒã˜ ID ã§å†åº¦ä½œæˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

### ã‚¢ãƒ—ãƒªå†…ã‚¢ã‚¤ãƒ†ãƒ  ID ã®æ±ºã‚æ–¹

Android: ã‚¢ã‚¤ãƒ†ãƒ  ID  
iOS: è£½å“ ID

ã“ã‚Œã‚‰ã¯ã‚¢ãƒ—ãƒªå†…ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸€æ„ã«å®šã‚ã‚‹å½¹å‰²ãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†ä¸Šæ”¯éšœãŒãªã‘ã‚Œã°ãªã‚“ã§ã‚‚ã„ã„ã¨æ€ã„ã¾ã™ãŒã€ç§ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«æ±ºã‚ã¾ã—ãŸã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ID.ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¿ã‚¤ãƒ—(ã‚µãƒ–ã‚¹ã‚¯ / æ¶ˆè²»å‹ãªã©).æœŸé–“.ã‚¢ã‚¤ãƒ†ãƒ å  
ä¾‹) com.sample.subscription.monthly.premium

## ãƒ•ãƒ­ãƒ¼ã¨å®Ÿè£…

å…·ä½“çš„ãªã‚±ãƒ¼ã‚¹ã”ã¨ã€å›³ã¨ã‚³ãƒ¼ãƒ‰ã‚’äº¤ãˆã¦èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ–ã‚¹ã‚¯è³¼å…¥ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸ

Flutter ã‚¢ãƒ—ãƒªãŒç›´æ¥ã‚¹ãƒˆã‚¢ã«å•ã„åˆã‚ã›ã¦ã‚¹ãƒˆã‚¢æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚

ã‚¹ãƒˆã‚¢æƒ…å ±ã¯ã‚¢ãƒ—ãƒªå†…ã§è¡¨ç¤ºã™ã‚‹ä¾¡æ ¼ãªã©ã«åˆ©ç”¨ã—ã¾ã™ã€‚ã“ã†ã™ã‚‹ã“ã¨ã§ã‚¢ãƒ—ãƒªå´ã§ä¾¡æ ¼æƒ…å ±ã‚’æŒãŸãªãã¦æ¸ˆã‚€ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å±•é–‹ã™ã‚‹ã“ã¨ã«ãªã£ã¦ã‚‚å®¹æ˜“ã«ç¾åœ°ã®ä¾¡æ ¼ã§è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](/images/in-app-purchase/billing_flow1.png)

#### Flutter å´ã®å®Ÿè£…

ç§ã¯èª²é‡‘é–¢ä¿‚ã®å‡¦ç†ã‚’ `ChangeNotifierProvider` ã¨ã—ã¦å®šç¾©ã—ã€Widget ãƒ„ãƒªãƒ¼ã® Root è¿‘ãã«ç½®ã„ã¦ã„ã¾ã™ã€‚

ãªãœ ChangeNotifier ãªã®ã‹ã¯å¾Œè¿°ã—ã¾ã™ã€‚

```dart
class BillingService extends StateNotifier<bool> {

  // ç•¥

  final InAppPurchase _connection = InAppPurchase.instance;

  List<String> _productIds = <String>[
    Platform.isIOS
        ? 'com.example.iod.appname.pro' // ãã‚Œãã‚Œã®productID
        : 'com.example.android.appname.pro'
  ];

  ProductDetails? _product; // èª²é‡‘ã‚¢ã‚¤ãƒ†ãƒ ã¯1ç¨®é¡ã¨ä»®å®šã™ã‚‹

  InAppPurchase get connection => _connection;
  ProductDetails? get product => _product;

  /// ã‚¹ãƒˆã‚¢æƒ…å ±ã®å–å¾—ã‚’è¡Œã†
  /// ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã‚„èª²é‡‘ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã«å®Ÿè¡Œã™ã‚‹
  Future _initStoreStatus() async {

    // ã‚¹ãƒˆã‚¢æƒ…å ±ãŒæœ‰åŠ¹ã‹åˆ¤æ–­
    final bool isAvailable = await _connection.isAvailable();

    if (!isAvailable) {
      return;
    }

    // ã‚µãƒ–ã‚¹ã‚¯ã®å•†å“æƒ…å ±ã‚’å–å¾—ã™ã‚‹
    ProductDetailsResponse productDetailResponse =
        await _connection.queryProductDetails(_productIds.toSet());

    if (productDetailResponse.error != null) {
      return;
    }

    if (productDetailResponse.productDetails.isEmpty) {
      return;
    }

    // èª²é‡‘ãƒ—ãƒ©ãƒ³ã¯1ã¤ã¨ä»®å®šã—ãŸå®Ÿè£…ã§ã™
    if (productDetailResponse.productDetails.length == 1 &&
        productDetailResponse.productDetails.first.id == _productIds.first) {
      _product = productDetailResponse.productDetails.first;
    }
  }
}
```

`ProductDetails` ã‹ã‚‰ã¯ä¾¡æ ¼ãªã©å–å¾—ã§ãã‚‹ã®ã§ã€ãã‚Œã‚’åˆ©ç”¨ã—ã¦ã‚¢ãƒ—ãƒªç”»é¢ä¸Šã«åæ˜ ã—ã¾ã™ã€‚

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ–ã‚¹ã‚¯è³¼å…¥ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ãŸ

ã€Œã‚µãƒ–ã‚¹ã‚¯è³¼å…¥ãƒœã‚¿ãƒ³ã®ã‚¿ãƒƒãƒ—ã€ ã‹ã‚‰ ã€Œèª²é‡‘ã®æ¤œè¨¼ã€ ã¾ã§ã‚’è¡Œã„ã¾ã™ã€‚

ã“ã®å‡¦ç†ã‹ã‚‰ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å®Ÿè£…ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ä»Šå›ã¯è¡¨é¡Œã®é€šã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å®Ÿè£…ã« Firebase (Firestore / Cloud Functions for Firebase)ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

![](/images/in-app-purchase/billing_flow2.png)

#### Flutter å´ã®å®Ÿè£…

```dart
class BillingService extends StateNotifier<bool> {
  BillingService() : super(false) {
    // èª²é‡‘å‡¦ç†ã‚’ç›£è¦–ã™ã‚‹
    Stream purchaseUpdated = _connection.purchaseStream;

    _subscription = purchaseUpdated.listen((purchaseDetailsList) {
      _listenToPurchaseUpdated(purchaseDetailsList);
    }, onDone: () {
      _subscription.cancel();
    }, onError: (error) {
    }) as StreamSubscription<List<PurchaseDetails>>;
  }

  late StreamSubscription<List<PurchaseDetails>> _subscription;
  final InAppPurchase _connection = InAppPurchase.instance;

  bool _isBillingUser = true;
  List<String> _productIds = <String>[
    Platform.isIOS
        ? 'app.histbet.histbet.subscription.monthly.pro'
        : 'app.histbet.subscription.monthly.pro'
  ];

  ProductDetails? _product; // ç¾åœ¨èª²é‡‘ã‚¢ã‚¤ãƒ†ãƒ ã¯1ç¨®é¡

  bool get isBillingUser => _isBillingUser;
  InAppPurchase get connection => _connection;
  ProductDetails? get product => _product;

  /// ã‚¹ãƒˆã‚¢æƒ…å ±ã®åˆæœŸåŒ–ã‚’è¡Œã†
  Future _initStoreStatus() async {
    // çœç•¥
  }

  /// ã‚µãƒ–ã‚¹ã‚¯ã®è³¼å…¥ã‚’å®Ÿè¡Œã™ã‚‹
  Future<void> buyNonConsumable() async {
    print("BUY NON CONSUMABLE");
    try {
      PurchaseParam purchaseParam = PurchaseParam(
        productDetails: product!,
        applicationUserName: null,
      );
      await _connection.buyNonConsumable(purchaseParam: purchaseParam);
    } catch (err) {
      // TODO
    }
  }

  /// CloudFunctionsçµŒç”±ã§ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼, æœŸé™æ¤œè¨¼, (æ¤œè¨¼æˆåŠŸã§ã‚ã‚Œã°)Firestoreã¸ãƒ¬ã‚·ãƒ¼ãƒˆç™»éŒ²ã‚’è¡Œã†
  Future<int> _verifyPurchase(PurchaseDetails purchaseDetails) async {
    print("VERIFY PURCHASE");

    try {
      // iOSã®ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼
      if (Platform.isIOS) {
        HttpsCallable verifyReceipt =
            FirebaseFunctions.instanceFor(region: 'asia-northeast1')
                .httpsCallable('verifyIos');
        final HttpsCallableResult result = await verifyReceipt.call(
            {'data': purchaseDetails.verificationData.localVerificationData});

        print("Verify Purchase RESULT: " + result.data.toString());
        return result.data[BillingConst.result];
      }
      // Androidã®ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼
      else if (Platform.isAndroid) {
        if (purchaseDetails is GooglePlayPurchaseDetails) {
          HttpsCallable verifyReceipt =
              FirebaseFunctions.instanceFor(region: 'asia-northeast1')
                  .httpsCallable('verifyAndroid');

          final HttpsCallableResult result = await verifyReceipt.call({
            'data': purchaseDetails.verificationData.localVerificationData,
            'signature': purchaseDetails.billingClientPurchase.signature
          });

          print("Verify Purchase RESULT: " + result.data.toString());
          return result.data[BillingConst.result];
        }
      }
      return BillingConst.UNEXPECTED_ERROR;
    } catch (_) {
      return BillingConst.UNEXPECTED_ERROR;
    }
  }

  /// è³¼å…¥å‡¦ç†ã®ãƒªã‚¹ãƒŠãƒ¼
  void _listenToPurchaseUpdated(
      List<PurchaseDetails> purchaseDetailsList) async {
    print("LISTEN TO PURCHASE UPDATED");

    if (purchaseDetailsList.isEmpty) {
      return;
    }

    purchaseDetailsList.forEach((PurchaseDetails purchaseDetails) async {

      // PurchaseStatus.pending
      if (purchaseDetails.status == PurchaseStatus.pending) {
        showPendingUI(true);
      } else {
        // PurchaseStatus.error
        if (purchaseDetails.status == PurchaseStatus.error) {
        }

        // PurchaseStatus.purchased
        else if (purchaseDetails.status == PurchaseStatus.purchased) {
          final result = await _verifyPurchase(purchaseDetails);
          if (result == BillingConst.SUCCESS) {
            _isBillingUser = true;
          }
        }

        // PurchaseStatus.restored
        else if (purchaseDetails.status == PurchaseStatus.restored) {
          final result = await _verifyPurchase(purchaseDetails);
          if (result == BillingConst.SUCCESS) {
            _isBillingUser = true;
          }
        }

        if (purchaseDetails.pendingCompletePurchase) {
          await _connection.completePurchase(purchaseDetails);
        }
        showPendingUI(false);
      }
    });
  }

  /// ç”»é¢ã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹
  void showPendingUI(bool pending) {
    state = pending;
  }
}

class BillingConst {
  static const String result = 'result';
  static const SUCCESS = 0; // æˆåŠŸ (æœŸé™å†…)
  static const EXPIRED = 1; // æœŸé™åˆ‡ã‚Œ
  static const DOCUMENT_NOT_FOUND = 2; // Firestoreã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã—
  static const NO_AUTH = 3; // èªè¨¼æƒ…å ±ãªã—
  static const INVALID_RECEIPT = 4; // ãƒ¬ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒä¸æ­£ã§ã™
  static const ALREADY_EXIST = 5; // åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¦ã„ã‚‹
  static const UNEXPECTED_ERROR = 99; // ä¸æ˜ãªã‚¨ãƒ©ãƒ¼
}
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ–ã‚¹ã‚¯è³¼å…¥ã®ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ãŸéš›ã«ã¯ä¸‹è¨˜å‡¦ç†ã‚’èµ°ã‚‰ã›ã¾ã™ã€‚

```dart
  /// ã‚µãƒ–ã‚¹ã‚¯ã®è³¼å…¥ã‚’å®Ÿè¡Œã™ã‚‹
  Future<void> buyNonConsumable() async {
    print("BUY NON CONSUMABLE");
    try {
      PurchaseParam purchaseParam = PurchaseParam(
        productDetails: product!,
        applicationUserName: null,
      );
      await _connection.buyNonConsumable(purchaseParam: purchaseParam);
    } catch (err) {
      // TODO
    }
  }
```

`_connection.buyNonConsumable` ã§ã‚¹ãƒˆã‚¢ã¨é€šä¿¡ã‚’è¡Œã„ã€è³¼å…¥å‡¦ç†ã®çŠ¶æ³ã¯ Stream ã§ç›£è¦–ã—ã¾ã™ã€‚

```dart
    Stream purchaseUpdated = _connection.purchaseStream;
    _subscription = purchaseUpdated.listen((purchaseDetailsList) {
      _listenToPurchaseUpdated(purchaseDetailsList);
    }, onDone: () {
      _subscription.cancel();
    }, onError: (error) {
    }) as StreamSubscription<List<PurchaseDetails>>;
```

è³¼å…¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå®Œäº†ã«ãªã‚Œã°è³¼å…¥æƒ…å ±ã‚’å–å¾—ã§ãã¾ã™ã€‚

```dart
  /// è³¼å…¥å‡¦ç†ã®ãƒªã‚¹ãƒŠãƒ¼
  void _listenToPurchaseUpdated(
      List<PurchaseDetails> purchaseDetailsList) async {
    print("LISTEN TO PURCHASE UPDATED");

    if (purchaseDetailsList.isEmpty) {
      return;
    }

    purchaseDetailsList.forEach((PurchaseDetails purchaseDetails) async {

      // PurchaseStatus.pending
      if (purchaseDetails.status == PurchaseStatus.pending) {
        showPendingUI(true);
      } else {
        // PurchaseStatus.error
        if (purchaseDetails.status == PurchaseStatus.error) {
        }

        // PurchaseStatus.purchased
        else if (purchaseDetails.status == PurchaseStatus.purchased) {
          final result = await _verifyPurchase(purchaseDetails);
          if (result == BillingConst.SUCCESS) {
            _isBillingUser = true;
          }
        }

        // PurchaseStatus.restored
        else if (purchaseDetails.status == PurchaseStatus.restored) {
          final result = await _verifyPurchase(purchaseDetails);
          if (result == BillingConst.SUCCESS) {
            _isBillingUser = true;
          }
        }

        if (purchaseDetails.pendingCompletePurchase) {
          await _connection.completePurchase(purchaseDetails);
        }
        showPendingUI(false);
      }
    });
  }
```

è³¼å…¥æƒ…å ±ã‚’å–å¾—ã—ãŸã‚‰ Cloud Functions ã§æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚

æ¤œè¨¼çµæœã®å—ã‘æ¸¡ã—ã«ã¯å€¤ã‚’ç‹¬è‡ªã«å®šç¾©ã—ã¦åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚(ã“ã“ã¯ã‚‚ã£ã¨ã‚¹ãƒãƒ¼ãƒˆãªæ–¹æ³•ã‚ã‚Šãã†ã€ã€)

```dart
  /// CloudFunctionsçµŒç”±ã§ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼, æœŸé™æ¤œè¨¼, (æ¤œè¨¼æˆåŠŸã§ã‚ã‚Œã°)Firestoreã¸ãƒ¬ã‚·ãƒ¼ãƒˆç™»éŒ²ã‚’è¡Œã†
  Future<int> _verifyPurchase(PurchaseDetails purchaseDetails) async {
    print("VERIFY PURCHASE");

    try {
      // iOSã®ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼
      if (Platform.isIOS) {
        HttpsCallable verifyReceipt =
            FirebaseFunctions.instanceFor(region: 'asia-northeast1')
                .httpsCallable('verifyIos');
        final HttpsCallableResult result = await verifyReceipt.call(
            {'data': purchaseDetails.verificationData.localVerificationData});

        print("Verify Purchase RESULT: " + result.data.toString());
        return result.data[BillingConst.result];
      }
      // Androidã®ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼
      else if (Platform.isAndroid) {
        if (purchaseDetails is GooglePlayPurchaseDetails) {
          HttpsCallable verifyReceipt =
              FirebaseFunctions.instanceFor(region: 'asia-northeast1')
                  .httpsCallable('verifyAndroid');

          final HttpsCallableResult result = await verifyReceipt.call({
            'data': purchaseDetails.verificationData.localVerificationData,
            'signature': purchaseDetails.billingClientPurchase.signature
          });

          print("Verify Purchase RESULT: " + result.data.toString());
          return result.data[BillingConst.result];
        }
      }
      return BillingConst.UNEXPECTED_ERROR;
    } catch (_) {
      return BillingConst.UNEXPECTED_ERROR;
    }
  }
```

å‚è€ƒã§ã™ãŒã€ç§ã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã‚’æ¤œçŸ¥ã—ãŸéš›ã« UI ã‚‚æ›´æ–°ã—ã¦ã„ã¾ã™ã€‚

å…ˆã«æ›¸ã„ãŸã‚ˆã†ã«ç§ã¯èª²é‡‘å‡¦ç†ç”¨ã‚¯ãƒ©ã‚¹ã‚’ root ä»˜è¿‘ã«ç½®ã„ã¦ã„ã¾ã™ãŒã€èª²é‡‘å‡¦ç†ç”¨ã‚¯ãƒ©ã‚¹ã‚’ StateNotifier ã«ã—ã¦èª²é‡‘å‡¦ç†ä¸­ã®ç”»é¢ãƒ­ãƒƒã‚¯ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚

```dart
  /// ç”»é¢ã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹
  void showPendingUI(bool pending) {
    state = pending;
  }
```

#### Firebase (Cloud Functions) å´ã®å®Ÿè£…

è³¼å…¥æƒ…å ±ã®æ¤œè¨¼ã«ã¯ Cloud Functions ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã¯å¿…è¦ãªç®‡æ‰€ã ã‘æŠœç²‹ã—ã¦ã„ã¾ã™ã€‚ã§ãã‚‹ã ã‘æ”¯éšœãŒãªã„ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ãŒã€æ•´åˆæ€§ã®å–ã‚Œã¦ã„ãªã„ã¨ã“ã‚ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```typescript
import * as functions from "firebase-functions";
import * as admin from "firebase-admin";

const firestore = admin.firestore();

const SUCCESS = 0; // æˆåŠŸ
const EXPIRED = 1; // æœŸé™åˆ‡ã‚Œ
const DOCUMENT_NOT_FOUND = 2; // Firestoreã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã—
const NO_AUTH = 3; // èªè¨¼æƒ…å ±ãªã—
const INVALID_RECEIPT = 4; // ãƒ¬ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒä¸æ­£ã§ã™
const ALREADY_EXIST = 5; // åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¦ã„ã‚‹
const UNEXPECTED_ERROR = 99; // ä¸æ˜ãªã‚¨ãƒ©ãƒ¼

// iOS è³¼å…¥ã‚’æ¤œè¨¼ã—ã¦Firestoreã«ä¿å­˜ã™ã‚‹
export const verifyIos = functions
  .region("asia-northeast1")
  .https.onCall(async (data, context) => {
    if (context.auth === null) {
      return { result: NO_AUTH };
    }

    const uid: string = context.auth!.uid;
    const verificationData: string = data["data"];

    const latestReceipt = await verifyReceiptIos(
      verificationData,
      context.auth
    );
    if (latestReceipt === null || latestReceipt === undefined) {
      return { result: INVALID_RECEIPT };
    }

    // åŒã˜TransactionIdãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€è³¼å…¥æƒ…å ±ãŒæ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ãªã„ã‹ç¢ºèªã™ã‚‹
    const queryId: admin.firestore.QuerySnapshot = await firestore
      .collectionGroup("receipts")
      .where("transactionId", "==", latestReceipt["transaction_id"])
      .get();

    if (!queryId.empty) {
      return { result: ALREADY_EXIST };
    }

    // TODO Firestoreã«ä¿å­˜ã™ã‚‹
    // æœ€ä½é™æœ€æ–°ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¦ãŠã‘ã°ã„ã„ã¨æ€ã„ã¾ã™

    // æœŸé™ãªã„ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
    const now: number = Date.now();
    const expireDate: number = Number(latestReceipt["expires_date_ms"]);
    if (now < expireDate) {
      return { result: SUCCESS };
    } else {
      return { result: EXPIRED };
    }
  });

// Android è³¼å…¥ã‚’æ¤œè¨¼ã—ã¦Firestoreã«ä¿å­˜ã™ã‚‹
export const verifyAndroid = functions
  .region("asia-northeast1")
  .https.onCall(async (data, context) => {
    if (context.auth === null) {
      return { result: NO_AUTH };
    }

    const uid: string = context.auth!.uid;
    const verificationData: string = data["data"];
    const signature: string = data["signature"];

    const latestReceipt = await verifyReceiptAndroid(
      verificationData,
      signature,
      context.auth
    );
    if (latestReceipt === null || latestReceipt === undefined) {
      return { result: INVALID_RECEIPT };
    }

    // åŒã˜orderIdãŒå­˜åœ¨ã—ãªã„ã‹ç¢ºèªã—ã€è³¼å…¥æƒ…å ±ãŒæ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ãªã„ã‹ç¢ºèªã™ã‚‹
    const queryId: admin.firestore.QuerySnapshot = await firestore
      .collectionGroup("receipts")
      .where("orderId", "==", latestReceipt["orderId"])
      .get();

    if (!queryId.empty) {
      return { result: ALREADY_EXIST };
    }

    // TODO Firestoreã«ä¿å­˜ã™ã‚‹
    // æœ€ä½é™æœ€æ–°ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¦ãŠã‘ã°ã„ã„ã¨æ€ã„ã¾ã™

    const now: number = Date.now();
    const expireDate: number = Number(latestReceipt["expiryTimeMillis"]);
    if (now < expireDate) {
      return { result: SUCCESS };
    } else {
      return { result: EXPIRED };
    }
  });
```

å®Ÿéš›ã«ã‚¹ãƒˆã‚¢ã® API ã‚’å©ã„ã¦æ¤œè¨¼ã™ã‚‹é–¢æ•°ã§ã™ã€‚

å¾Œã«èª¬æ˜ã—ã¾ã™ãŒã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°å®Ÿè¡Œã™ã‚‹ãŸã‚ã«æ¤œè¨¼éƒ¨ã¯åˆ¥ã«åˆ‡ã‚Šå‡ºã—ã¦ã„ã¾ã™ã€‚

```typescript
import * as functions from "firebase-functions";
import axios, { AxiosResponse } from "axios";
import * as crypto from "crypto";
import { google } from "googleapis";

const PACKAGE_NAME_IOS = "com.example";
const PACKAGE_NAME_ANDROID = "com.example";

const RECEIPT_VERIFICATION_ENDPOINT_FOR_IOS_SANDBOX =
  "https://sandbox.itunes.apple.com/verifyReceipt";
const RECEIPT_VERIFICATION_ENDPOINT_FOR_IOS_PROD =
  "https://buy.itunes.apple.com/verifyReceipt";
const RECEIPT_VERIFICATION_ENDPOINT_FRO_ANDROID =
  "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/";

// Androidæ¤œè¨¼ç”¨ã®AuthClient
const authClient = new google.auth.JWT({
  email: SERVICE_CLIENT_EMAIL_FOR_ANDROID,
  key: SERVICE_PRIVATE_KEY_FOR_ANDROID,
  scopes: ["https://www.googleapis.com/auth/androidpublisher"],
});

// ãƒ¬ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ã—ã¦latest_receiptã‚’è¿”ã™
// latest_receiptä»¥å¤–ã«ã¯è‡ªå‹•è³¼èª­ã®æœ‰åŠ¹/ç„¡åŠ¹ãªã©ã®æƒ…å ±ã‚‚ã‚ã‚‹ãŒã€ç¾çŠ¶ã¯latest_receiptã ã‘ã§ååˆ†ãªæƒ…å ±é‡ã¨è€ƒãˆã‚‹
export async function verifyReceiptIos(verificationData: string, auth: any) {
  let response: AxiosResponse;
  try {
    // æœ¬ç•ªç”¨APIã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹
    response = await axios.post(RECEIPT_VERIFICATION_ENDPOINT_FOR_IOS_PROD, {
      "receipt-data": verificationData,
      password: "TODO",
      "exclude-old-transactions": true,
    });

    // æœ¬ç•ªç”¨APIã‹ã‚‰è¿”å´ã•ã‚ŒãŸ`status`ãŒ`21007`ã®å ´åˆã€é€ä¿¡ã•ã‚ŒãŸãƒ¬ã‚·ãƒ¼ãƒˆãŒã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒç”¨ã¨åˆ¤æ–­ã™ã‚‹
    if (response.data && response.data["status"] === 21007) {
      response = await axios.post(
        RECEIPT_VERIFICATION_ENDPOINT_FOR_IOS_SANDBOX,
        {
          "receipt-data": verificationData,
          password: "TODO",
          "exclude-old-transactions": true,
        }
      );
    }

    // ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼ç”¨APIã‹ã‚‰è¿”å´ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…ã®`status`ãŒ`0`ã§ã‚ã‚Œã°æ¤œè¨¼ã¯æˆåŠŸ https://developer.apple.com/documentation/appstorereceipts/status#possible-values
    const result = response.data;
    if (result["status"] !== 0) {
      return null;
    }

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿å†…ã®`bundle_id`ãŒè‡ªèº«ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹
    if (
      !result["receipt"] ||
      result["receipt"]["bundle_id"] !== PACKAGE_NAME_IOS
    ) {
      return null;
    }

    // `latest_receipt_info`ã¯å®šæœŸè³¼èª­ã‚¿ã‚¤ãƒ—ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è³¼å…¥ã—ãŸã“ã¨ãŒã‚ã‚‹å ´åˆã®ã¿å­˜åœ¨ã™ã‚‹
    return result["latest_receipt_info"][0];
  } catch (err) {
    return null;
  }
}

export async function verifyReceiptAndroid(
  verificationData: string,
  signature: string,
  auth: any
) {
  try {
    // éµãŒã‚ã‚‹ãªã‚‰æ¤œè¨¼ã‚’è¡Œã† (renewã®æ™‚ã«ã¯ä¸è¦)
    if (signature !== "") {
      const validator = crypto.createVerify("SHA1");
      validator.update(verificationData);
      let validity = false;
      validity = validator.verify(
        STORE_PUBLIC_KEY_FOR_ANDROID,
        signature,
        "base64"
      );
      if (!validity) {
        return null;
      }
    }

    const decodedReceipt = JSON.parse(verificationData);

    // ã‚µãƒ–ã‚¹ã‚¯å•†å“ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
    if (!decodedReceipt["autoRenewing"]) {
      return null;
    }

    const credential = await authClient.authorize();

    const url =
      RECEIPT_VERIFICATION_ENDPOINT_FRO_ANDROID +
      PACKAGE_NAME_ANDROID +
      "/purchases/subscriptions/" +
      decodedReceipt["productId"] +
      "/tokens/" +
      decodedReceipt["purchaseToken"] +
      "?access_token=" +
      credential.access_token;

    const response = await axios.get(url);

    const verifiedData = response.data;
    if (!verifiedData) {
      return null;
    }
    return verifiedData;
  } catch (err) {
    return null;
  }
}
```

æ¤œè¨¼ã«ä½¿ã†ç§˜å¯†æƒ…å ±ã¯ä¸‹è¨˜ã§ã™ã€‚ãã‚Œãã‚Œå„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«çµŒç”±ã§å–å¾—ã§ãã¾ã™ã€‚

```typescript
RECEIPT_VERIFICATION_PASSWORD_FOR_IOS = "Appç”¨å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ";
SERVICE_CLIENT_EMAIL_FOR_ANDROID =
  "Play Consoleã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—ã—ã¾ã™";
SERVICE_PRIVATE_KEY_FOR_ANDROID =
  "-----BEGIN PUBLIC KEY-----\nPUBLICã‚­ãƒ¼ã«64æ–‡å­—ã”ã¨æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’æŒŸã‚“ã§ã„ã\n-----END PUBLIC KEY-----\n"; // ã“ã¡ã‚‰ã‚‚JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—ã—ã¾ã™
STORE_PUBLIC_KEY_FOR_ANDROID =
  "-----BEGIN PUBLIC KEY-----\nPUBLICã‚­ãƒ¼ã«64æ–‡å­—ã”ã¨æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’æŒŸã‚“ã§ã„ã\n-----END PUBLIC KEY-----\n"; // Play Consoleã«ã‚ã‚‹ã‚¢ãƒ—ãƒªã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç”¨éµã‚’åˆ©ç”¨ã—ã¾ã™
```

Cloud Functions ã§ç§˜å¯†æƒ…å ±ã‚’ä½¿ã†å ´åˆã€ç’°å¢ƒå¤‰æ•°ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã¯æ¨å¥¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç°¡å˜ãªæ–¹æ³•ã¨ã—ã¦ã¯ã€Œã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ç›´æ¥åŸ‹ã‚è¾¼ã‚€ã€ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://cloud.google.com/functions/docs/env-var?hl=ja:embed:cite

Google ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯ä¸‹è¨˜ã®æ¨©é™ã‚’ä»˜ä¸ã—ã¦ã„ã¾ã™ã€‚å®šæœŸè³¼å…¥ãŒãªãã¦ã‚‚ã„ã‘ã¾ã—ãŸã€‚

![](/images/in-app-purchase/google_permission.png)

### 3. ã‚µãƒ–ã‚¹ã‚¯è³¼å…¥æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ãŸ

ã“ã“ã§ã¯ã‚¹ãƒˆã‚¢ã¨é€šä¿¡ã‚’è¡Œã„ã¾ã›ã‚“ã€‚

Firestore ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç¢ºèªã—ã€ã‚µãƒ–ã‚¹ã‚¯ãŒæœ‰åŠ¹ã§ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

![](/images/in-app-purchase/billing_flow3.png)

:::message
ã‚¢ãƒ—ãƒªå†…ã‹ã‚‰ç›´æ¥ Firestore ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç¢ºèªã—ã¦ã‚‚ã„ã„ã§ã™ãŒã€ã‚µãƒ–ã‚¹ã‚¯æœŸé™å†…ã‹åˆ¤æ–­ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚¢ãƒ—ãƒªå†…ã«ã‚ã‚‹å ´åˆã€ç«¯æœ«ã®æ™‚é–“ãŒã‚ºãƒ¬ã¦ã„ãŸã‚Šã‚ã‚‹ã„ã¯æ‚ªæ„ã‚’æŒã£ã¦ãšã‚‰ã—ã¦ã„ãŸã‚Šã™ã‚‹ã¨æ„å›³ã—ãªã„åˆ¤æ–­ã‚’ã—ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€ŒCloud Functions çµŒç”±ã§èª²é‡‘æƒ…å ±ã®ç¢ºèªã‚’è¡Œã„ã€Cloud Functions å†…ã§æœŸé™å†…ã‹åˆ¤æ–­ã™ã‚‹ã€ã‚„ã€Œæœ€åˆã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å†…ã«æœ‰åŠ¹ç„¡åŠ¹ã®ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦ãŠãã€æœŸé™ã®éããŸã‚‚ã®ãŒã‚ã‚Œã°äº‹å‰ã«ã‚µãƒ¼ãƒãƒ¼å†…ã§ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°ã—ã¦ãŠãã€ãªã©ã®å¯¾ç­–ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
:::

### 4. ã‚µãƒ–ã‚¹ã‚¯ãŒè‡ªå‹•æ›´æ–°ã—ãŸ

ã‚µãƒ–ã‚¹ã‚¯ã®æœŸé™ãŒæ¥ã‚‹ã¨å„ã‚¹ãƒˆã‚¢ãŒæ›´æ–°å‡¦ç†ã‚’è¡Œã„ã€ç„¡äº‹æ±ºæ¸ˆãŒå®Œäº†ã™ã‚‹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ–ã‚¹ã‚¯æœŸé™ãŒå»¶é•·ã•ã‚Œã¾ã™ã€‚

ã‚µãƒ–ã‚¹ã‚¯ãŒã‚¹ãƒˆã‚¢å†…ã§æ›´æ–°ã•ã‚ŒãŸãªã‚‰ã° Firestore å´ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚‚æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ›´æ–°æ–¹æ³•ã¨ã—ã¦ 2 ã¤ç´¹ä»‹ã—ã¾ã™ã€‚

#### 1. ã‚¹ãƒˆã‚¢ã®ã‚µãƒ¼ãƒãƒ¼é€šçŸ¥æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹

èª²é‡‘æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã‚‹ãŸã³ã«ã‚¹ãƒˆã‚¢ã‹ã‚‰é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
é€šçŸ¥ã‚’å—ã‘å–ã£ãŸã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ã‚µãƒ–ã‚¹ã‚¯æœŸé™ã‚’æ›´æ–°ã—ã¾ã™ã€‚  
å®Ÿè£…ã™ã‚‹ãŸã‚ã«ã¯ã‚¹ãƒˆã‚¢ã‹ã‚‰ã®é€šçŸ¥ã‚’å—ã‘å–ã‚‹ç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚(PubSub ã¨ã‹)

https://help.apple.com/app-store-connect/#/dev0067a330b

https://developer.android.com/google/play/billing/getting-ready?hl=ja

![](/images/in-app-purchase/billing_flow4_1.png)

#### 2. å®šæœŸçš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ–ã‚¹ã‚¯æœŸé™ã‚’ç¢ºèªã™ã‚‹

Cloud Functions ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãªã©ã§å®šæœŸçš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª²é‡‘æƒ…å ±å•ã„åˆã‚ã›ã‚’è¡Œã„ã€ã‚µãƒ–ã‚¹ã‚¯æœŸé™ã®æ›´æ–°ãŒã‚ã‚Œã° Firestore ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ã€‚

![](/images/in-app-purchase/billing_flow4_2.png)

#### ç§ãŒæ¡ç”¨ã—ã¦ã„ã‚‹æ›´æ–°ç¢ºèªæ–¹æ³•

ã€Œå®šæœŸçš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ–ã‚¹ã‚¯æœŸé™ã‚’ç¢ºèªã™ã‚‹ã€ã§æ›´æ–°ç¢ºèªã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚ç’°å¢ƒæ§‹ç¯‰ã‚‚å®Ÿè£…ã‚‚ç°¡å˜ã§ã‚ã‚‹ã¨è€ƒãˆãŸãŸã‚ã§ã™ã€‚

ä¸‹è¨˜ãƒ•ãƒ­ãƒ¼ã‚’ 1 æ™‚é–“ã« 1 å›èµ°ã‚‰ã›ã¦ã„ã¾ã™ã€‚

1. Firestore ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€Œã‚µãƒ–ã‚¹ã‚¯æœŸé™ã¾ã§ 2 æ™‚é–“åˆ‡ã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‹ã‚‰ ã‚µãƒ–ã‚¹ã‚¯æœŸé™ã‹ã‚‰ 2 æ™‚é–“çµŒéã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã¾ã§ã€ã‚’æŠ½å‡ºã™ã‚‹ã€‚
2. Firestore ã«ä¿å­˜æ¸ˆã¿ã®è³¼å…¥æƒ…å ±ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã—ã€ã‚¹ãƒˆã‚¢ã«è³¼å…¥æƒ…å ±ã®æ¤œè¨¼ã‚’ä¾é ¼ã™ã‚‹ã€‚
3. 2 ã§å—ã‘å–ã£ãŸæ¤œè¨¼çµæœ(è³¼å…¥æƒ…å ±)ã‚’ç¢ºèªã™ã‚‹ã€‚
4. ã‚µãƒ–ã‚¹ã‚¯æœŸé™ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚Œã° Firestore ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚‚æ›´æ–°ã™ã‚‹ã€‚

> ãªãœæœŸé™å‰å¾Œ 2 æ™‚é–“ã‚’æŠ½å‡ºã—ã¦ã„ã‚‹ã®ã‹ï¼Ÿ

ãƒ•ãƒ­ãƒ¼ãŒèµ°ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ˆã‚Šæ¤œè¨¼æ¼ã‚ŒãŒç™ºç”Ÿã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã§ã™ã€‚å®Ÿéš›ã®ã¨ã“ã‚ã‚µãƒ–ã‚¹ã‚¯å‰å¾Œ 1 æ™‚é–“ã§ã‚‚ååˆ†ã¨æ€ã„ã¾ã™ãŒã€äºŒé‡ã«æ¤œè¨¼ã—ã¦ã‚‚ã‚³ã‚¹ãƒˆçš„ã«ã‚‚å¤§ããªå•é¡Œã¨ã¯ãªã‚‰ãªã„ãŸã‚è‹¥å¹²ã®ä½™è£•ã‚’æŒãŸã›ã¦ã„ã¾ã™ã€‚

:::message
è³¼å…¥æƒ…å ±æ¤œè¨¼ç”¨ã® API ã®å‘¼ã³å‡ºã—å›æ•°ã«ã¯åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€å¤§è¦æ¨¡ã‚¢ãƒ—ãƒªã«ãŠã„ã¦ã¯ã‚¹ãƒˆã‚¢ã‹ã‚‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
:::

> æ³¨: å‰²ã‚Šå½“ã¦åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼é€šçŸ¥ã‚’æ´»ç”¨ã›ãšã« Google Play Developer API ã‚’å®šæœŸçš„ã«ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚

https://developer.android.com/google/play/billing/subscriptions?hl=ja:embed:cite

https://developers.google.com/android-publisher/quotas?hl=ja:embed:cite

iOS ã«ã¤ã„ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€åˆ¶é™ãŒã‚ã‚‹å‰æã§è€ƒãˆãŸæ–¹ãŒç„¡é›£ã ã¨æ€ã„ã¾ã™ã€‚

### 5. è³¼å…¥æƒ…å ±ã®å¾©å…ƒãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ãŸ

å„ã‚¹ãƒˆã‚¢ã® API ã‚’å©ãã€éå»ã®è³¼å…¥æƒ…å ±ã‚’å…¥æ‰‹ã—ã¦å†æ¤œè¨¼ã—ã¾ã™ã€‚è³¼å…¥æƒ…å ±ã¯ purchaseStream ã§å—ã‘å–ã‚Šã¾ã™ã€‚

![](/images/in-app-purchase/billing_flow5.png)

```dart
class BillingService extends StateNotifier<bool> {
  BillingService() : super(false) {
    // ç•¥
  }

  // ç•¥

  /// ã‚¹ãƒˆã‚¢æƒ…å ±ã®åˆæœŸåŒ–ã‚’è¡Œã†
  Future _initStoreStatus() async {
    // ç•¥
  }

  /// ã‚µãƒ–ã‚¹ã‚¯ã®è³¼å…¥ã‚’å®Ÿè¡Œã™ã‚‹
  Future<void> buyNonConsumable() async {
    // ç•¥
  }

  /// CloudFunctionsçµŒç”±ã§ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼, æœŸé™æ¤œè¨¼, (æ¤œè¨¼æˆåŠŸã§ã‚ã‚Œã°)Firestoreã¸ãƒ¬ã‚·ãƒ¼ãƒˆç™»éŒ²ã‚’è¡Œã†
  Future<int> _verifyPurchase(PurchaseDetails purchaseDetails) async {
    // ç•¥
  }

  /// restorePurchaseã‚’å®Ÿè¡Œã™ã‚‹ã¨buyNonConsumableã¨åŒã˜ã‚ˆã†ã«purchaseStreamãŒèµ°ã‚‹
  Future<void> restorePurchase() async {
    print("RESTORE BILLING");
    try {
      await _connection.restorePurchases();
    } catch (_) {}
  }

  /// è³¼å…¥å‡¦ç†ã®ãƒªã‚¹ãƒŠãƒ¼
  void _listenToPurchaseUpdated(
    List<PurchaseDetails> purchaseDetailsList) async {
    print("LISTEN TO PURCHASE UPDATED");

    if (purchaseDetailsList.isEmpty) {
      return;
    }

    purchaseDetailsList.forEach((PurchaseDetails purchaseDetails) async {

      // PurchaseStatus.pending
      if (purchaseDetails.status == PurchaseStatus.pending) {
        showPendingUI(true);
      } else {
        // PurchaseStatus.error
        if (purchaseDetails.status == PurchaseStatus.error) {
        }

        // PurchaseStatus.purchased
        else if (purchaseDetails.status == PurchaseStatus.purchased) {
          final result = await _verifyPurchase(purchaseDetails);
          if (result == BillingConst.SUCCESS) {
            _isBillingUser = true;
          }
        }

        // PurchaseStatus.restored
        else if (purchaseDetails.status == PurchaseStatus.restored) {
          final result = await _verifyPurchase(purchaseDetails);
          if (result == BillingConst.SUCCESS) {
            _isBillingUser = true;
          }
        }

        if (purchaseDetails.pendingCompletePurchase) {
          await _connection.completePurchase(purchaseDetails);
        }
        showPendingUI(false);
      }
    });
  }

  /// ç”»é¢ã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹
  void showPendingUI(bool pending) {
    state = pending;
  }
}
```

## ãã®ä»–è£œè¶³ãªã©

### è³¼å…¥æƒ…å ±ã®æ¤œè¨¼ã‚’ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§è¡Œã†

å°è¦æ¨¡ã‚¢ãƒ—ãƒªãªã‚‰ã‚ã–ã‚ã–ã‚µãƒ¼ãƒãƒ¼å´ã§è³¼å…¥æƒ…å ±ã‚’æ¤œè¨¼ã›ãšã¨ã‚‚ã€ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«å´ã§æ¤œè¨¼ã™ã‚Œã°ååˆ†ã§ã¯ãªã„ã‹ã¨è€ƒãˆã‚‹æ–¹ã‚‚ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã—ã‹ã—ãªãŒã‚‰ã€ãã‚Œã¯ã€ŒæŠ€è¡“çš„ã«ã¯å¯èƒ½ã‹ã‚‚ã—ã‚Œãªã„ãŒã€æ¨å¥¨ã¯ä¸€åˆ‡ã§ããªã„ã€ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

ä¸€ç•ªã®ç†ç”±ã¯ Apple å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯æ˜ç¤ºçš„ã«ç¦ã˜ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚(Android ã‚‚ã©ã“ã‹ã«æ›¸ã„ã¦ã‚ã£ãŸæ°—ãŒã—ã¾ã™ãŒã€è¨˜è¼‰å ´æ‰€ã‚’å¿˜ã‚Œã¦ã—ã¾ã£ãŸ)

https://developer.apple.com/jp/documentation/storekit/in-app_purchase/validating_receipts_with_the_app_store/:title

ã¾ãŸã€å…ˆã«è¿°ã¹ãŸ API å‘¼ã³å‡ºã—å›æ•°ã®å•é¡Œã‚‚ã‚ã‚Šã¾ã™ã®ã§æ¨å¥¨ã¯ã§ãã¾ã›ã‚“ã€‚

### RevenueCat

ã“ã“ã¾ã§ Firestore ã‚„ Cloud Functions ã‚’é§†ä½¿ã—ã¦è³¼å…¥æƒ…å ±ã®æ¤œè¨¼ã‚’èª¬æ˜ã—ã¦ãã¾ã—ãŸãŒã€æœ€è¿‘ã¯è³¼å…¥æƒ…å ±ã®æ¤œè¨¼ã‚’ä»£ã‚ã‚Šã«è¡Œã£ã¦ãã‚Œã‚‹ RevenueCat ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

è‡ªåˆ†ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ç”¨æ„ã—ãªãã¦ã‚‚ã„ã„ã®ã¯æ¥½ãã†ã§ã™ã­ã€‚ã‚‚ã—ç§ãŒæœ¬ã‚¢ãƒ—ãƒªä½œæˆå‰ã«çŸ¥ã£ã¦ã„ãŸã‚‰åˆ©ç”¨ã—ã¦ã„ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

https://www.revenuecat.com/:embed:cite

## å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ãŸã‚µã‚¤ãƒˆ

https://tkzo.jp/blog/flutter-iap-implementation/:title

https://ameblo.jp/principia-ca/entry-12071725733.html:title

https://qiita.com/ckm/items/b8cf23ba4bd0ae5bbf34:title

https://devpixiv.hatenablog.com/entry/2014/12/09/111310:title
